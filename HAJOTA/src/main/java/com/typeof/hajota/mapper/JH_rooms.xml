<?xml version="1.0" encoding="UTF-8"?>

<!-- ===== #26. mapper 기본설정 ===== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- ===== #27. 루트엘리먼트 & 네임스페이스 설정(프로젝트 전체 내에서 고유해야 한다.) ===== -->
<mapper namespace="JH_rooms">
	<!-- 등록된 룸 리스트 -->
	<resultMap type="java.util.HashMap" id="roomsListMap">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	 		<result property="EMAIL" 			column="email" 			javaType="String" />
	 		<result property="NAME" 			column="name" 			javaType="String" />
	 		<result property="TYPE_LODGE" 		column="type_lodge" 	javaType="int" />
	 		<result property="TYPE_BUILDING"	column="type_building" 	javaType="int" />
	 		<result property="LOCATION" 		column="location" 		javaType="String" />
	 		<result property="LAT" 				column="lat" 			javaType="double" />
	 		<result property="LON" 				column="lon" 			javaType="double" />
	 		<result property="IMG_MAIN" 		column="img_main" 		javaType="String" />
	 		<result property="NUM_OF_PEOPLE" 	column="num_of_people" 	javaType="int" />
	 		<result property="ROOM_PRICE" 		column="room_price" 	javaType="int" />
	 		<result property="DEPOSIT_PRICE" 	column="deposit_price" 	javaType="int" />
	 		<result property="CLEAN_PRICE" 		column="clean_price" 	javaType="int" />
	 		<result property="TOTAL_PRICE" 		column="total_price" 	javaType="int" />
	 		<result property="STATUS" 			column="status" 		javaType="int" />
	</resultMap>

	<select id="selectRoomsList" parameterType="java.util.HashMap" resultMap="roomsListMap">
 		select seq_lodge
        from tbl_lodge
        where status = 1

        <!-- 검색어 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and location like '%' || #{search_content} || '%'
        	or name like '%' || #{search_content} || '%'
        </if>
        
        <!-- 인원수 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and num_of_people <![CDATA[>=]]> #{str_numOfPeople}
        </if>
        
        order by seq_lodge desc
 	</select>
 	
 	<!-- 예약 되어 있는 숙소 시퀀스 보기 -->
 	<resultMap type="java.util.HashMap" id="unavailableSeqLodeListMap">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	</resultMap>

	<select id="selectUnavailableSeqLodgeList" parameterType="java.util.HashMap" resultMap="unavailableSeqLodeListMap">
 		select seq_lodge 
        from tbl_payment
        where 1 = 1
        	and status = 1
        
        <!-- 날짜 검색 -->
        <if test='(startDate != null and !"".equals(startDate)) and (endDate != null and !"".equals(endDate))'>
        	and (#{startDate} <![CDATA[<=]]> checkin_date and checkout_date <![CDATA[<=]]> #{endDate})
        </if>
        
        group by seq_lodge
        order by seq_lodge desc
 	</select>
 	
 	<!-- 사용할 수 있는 숙소 정보 보기 -->
 	<resultMap type="java.util.HashMap" id="availableRoomsListMap">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	 		<result property="EMAIL"	 		column="email"		 	javaType="String" />
	 		<result property="NAME" 			column="name" 			javaType="String" />
	 		<result property="TYPE_LODGE" 		column="type_lodge" 	javaType="int" />
	 		<result property="TYPE_BUILDING"	column="type_building" 	javaType="int" />
	 		<result property="LOCATION" 		column="location" 		javaType="String" />
	 		<result property="LAT" 				column="lat" 			javaType="double" />
	 		<result property="LON" 				column="lon" 			javaType="double" />
	 		<result property="IMG_MAIN" 		column="img_main" 		javaType="String" />
	 		<result property="NUM_OF_PEOPLE" 	column="num_of_people" 	javaType="int" />
	 		<result property="ROOM_PRICE" 		column="room_price" 	javaType="int" />
	 		<result property="DEPOSIT_PRICE" 	column="deposit_price" 	javaType="int" />
	 		<result property="CLEAN_PRICE" 		column="clean_price" 	javaType="int" />
	 		<result property="TOTAL_PRICE" 		column="total_price" 	javaType="int" />
	 		<result property="STATUS" 			column="status" 		javaType="int" />
	</resultMap>

	<select id="selectAvailableRoomsList" parameterType="java.util.HashMap" resultMap="availableRoomsListMap">
 		select *
		from tbl_lodge
		where 1 = 1
        	and status = 1
        
        <!-- 검색어 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and location like '%' || #{search_content} || '%'
        	or name like '%' || #{search_content} || '%'
        </if>
        
        <!-- 인원수 -->
        <if test='str_numOfPeople != null and !"".equals(str_numOfPeople)'>
        	and num_of_people <![CDATA[>=]]> #{str_numOfPeople}
        </if>
        
        <!-- 인덱스로 검색 -->
        <if test='seq_lodgeArr != null'>
        	and not (seq_lodge in
        	<foreach collection="seq_lodgeArr" item="item" index="i" open="(" close=")" separator="," >   
        		${seq_lodgeArr[i]}
        	</foreach>
        	)
        </if>
        
        order by seq_lodge desc
 	</select>
 	
 	
 	
 	<!-- 맵 중심에서 거리 내 숙소 보기 -->
 	<resultMap type="java.util.HashMap" id="nearFromCenterRoomsList">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	 		<result property="EMAIL" 			column="email" 			javaType="String" />
	 		<result property="NAME" 			column="name" 			javaType="String" />
	 		<result property="TYPE_LODGE" 		column="type_lodge" 	javaType="int" />
	 		<result property="TYPE_BUILDING"	column="type_building" 	javaType="int" />
	 		<result property="LOCATION" 		column="location" 		javaType="String" />
	 		<result property="LAT" 				column="lat" 			javaType="double" />
	 		<result property="LON" 				column="lon" 			javaType="double" />
	 		<result property="IMG_MAIN" 		column="img_main" 		javaType="String" />
	 		<result property="NUM_OF_PEOPLE" 	column="num_of_people" 	javaType="int" />
	 		<result property="PADD_PRICE" 		column="padd_price" 	javaType="int" />
	 		<result property="ROOM_PRICE" 		column="room_price" 	javaType="int" />
	 		<result property="CLEAN_PRICE" 		column="clean_price" 	javaType="int" />
	 		<result property="TOTAL_PRICE" 		column="total_price" 	javaType="int" />
	 		<result property="STATUS" 			column="status" 		javaType="int" />
	 		<result property="DISTANCE" 		column="distance" 		javaType="double" />
	</resultMap>

	<select id="selectNearFromCenterRoomsList" parameterType="java.util.HashMap" resultMap="nearFromCenterRoomsList">
 		select *
		from (select seq_lodge, host_email, name, type_lodge, type_building, location, lat, lon, img_main, num_of_people, padd_price, deposit_price, clean_price, total_price, status, DISTNACE_WGS84(#{afterLat}, #{afterLon}, lat, lon) as distance
	        from tbl_lodge
	        where status = 1
                and (lat between #{afterLat} - 0.019 and #{afterLat} + 0.019)
                and (lon between #{afterLon} - 0.022 and #{afterLon} + 0.022)
                order by DISTANCE)
		where distance <![CDATA[<=]]> #{distance}
 	</select>
 	
 	
 	<!-- 이용 가능한 숙소의 전체 수 알기 -->
	<select id="selectAvailableRoomsCount" parameterType="java.util.HashMap" resultType="int">
 		select count(*) as count
		from tbl_lodge
		where 1 = 1
        	and status = 1
        
        <!-- 검색어 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and location like '%' || #{search_content} || '%'
        	or name like '%' || #{search_content} || '%'
        </if>
        
        <!-- 인원수 -->
        <if test='str_numOfPeople != null and !"".equals(str_numOfPeople)'>
        	and num_of_people <![CDATA[>=]]> #{str_numOfPeople}
        </if>
        
        <!-- 인덱스로 검색 -->
        <if test='seq_lodgeArr != null'>
        	and not (seq_lodge in
        	<foreach collection="seq_lodgeArr" item="item" index="i" open="(" close=")" separator="," >   
        		${seq_lodgeArr[i]}
        	</foreach>
        	)
        </if>
        
        order by seq_lodge desc
 	</select>
 	
 	
 	<!-- 
 	맵 중심에서 거리 내 숙소 보기
 	<resultMap type="java.util.HashMap" id="nearFromCenterRoomsList">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	 		<result property="HOST_EMAIL" 		column="host_email" 	javaType="String" />
	 		<result property="NAME" 			column="name" 			javaType="String" />
	 		<result property="TYPE_LODGE" 		column="type_lodge" 	javaType="String" />
	 		<result property="TYPE_BUILDING"	column="type_building" 	javaType="String" />
	 		<result property="LOCATION" 		column="location" 		javaType="String" />
	 		<result property="LAT" 				column="lat" 			javaType="double" />
	 		<result property="LON" 				column="lon" 			javaType="double" />
	 		<result property="IMG_MAIN" 		column="img_main" 		javaType="String" />
	 		<result property="NUM_OF_PEOPLE" 	column="num_of_people" 	javaType="int" />
	 		<result property="PADD_PRICE" 		column="padd_price" 	javaType="int" />
	 		<result property="DEPOSIT_PRICE" 	column="deposit_price" 	javaType="int" />
	 		<result property="CLEAN_PRICE" 		column="clean_price" 	javaType="int" />
	 		<result property="TOTAL_PRICE" 		column="total_price" 	javaType="int" />
	 		<result property="STATUS" 			column="status" 		javaType="int" />
	 		<result property="DISTANCE" 		column="distance" 		javaType="double" />
	</resultMap>

	<select id="selectNearFromCenterRoomsList" parameterType="java.util.HashMap" resultMap="nearFromCenterRoomsList">
 		select *
		from (select seq_lodge, host_email, name, type_lodge, type_building, location, lat, lon, img_main, num_of_people, padd_price, deposit_price, clean_price, total_price, status, DISTNACE_WGS84(#{afterLat}, #{afterLon}, lat, lon) as distance
	        from tbl_lodge
		        where status = 1
                and (lat between #{afterLat} - 0.019 and #{afterLat} + 0.019)
                and (lon between #{afterLon} - 0.022 and #{afterLon} + 0.022)
                order by DISTANCE)
		where distance <![CDATA[<=]]> #{distance}
 	</select> -->
 	
 	
 	
 	<!-- 숙소 입력 -->
 	<insert id="insertLodge" parameterType="java.util.HashMap">
 		insert into tbl_lodge(seq_lodge, email, name, type_lodge, type_building, location, location_detail, lat, lon, img_main, num_of_people, room_price, deposit_price, clean_price, total_price, status)
		values (seq_lodge.nextval, #{email}, #{name}, #{type_lodge}, #{type_building}, #{location}, #{location_detail}, #{lat}, #{lon}, #{mainimagename}, #{num_of_people}, #{room_price}, #{deposit_price}, #{clean_price}, #{total_price}, default)
 	</insert>
 	
 	<insert id="insertLodgeIntro" parameterType="java.util.HashMap">
 		insert into tbl_lodge_intro(seq_lodge, rooms_explain, rooms_rule, refund_policy, safety_function, local_information)
		values(seq_lodge.currval, #{rooms_explain}, #{rooms_rule}, #{refund_policy}, #{safety_function}, #{local_information})
 	</insert>
 	
 	<insert id="insertLodgeDetail" parameterType="java.util.HashMap">
 		insert into tbl_lodge_detail(seq_lodge, num_of_bathroom, num_of_bedroom, num_of_bed, checkin_time, checkout_time)
		values(seq_lodge.currval, #{num_of_bathroom}, #{num_of_bedroom}, #{num_of_bed}, #{checkin_time}, #{checkout_time})
 	</insert>
 	
 	<insert id="insertLodgeDetail2" parameterType="java.util.HashMap">
 		insert into tbl_lodge_detail2(seq_lodge, elevator, wifi, air_controller, heating, washing_machine, hair_dryer, tv, essential_item)
		values(seq_lodge.currval, #{elevator}, #{wifi}, #{air_controller}, #{heating}, #{washing_machine}, #{hair_dryer}, #{tv}, #{essential_item})
 	</insert>
 	
 	<insert id="insertLodgeImage" parameterType="java.util.HashMap">
		insert into TBL_LODGE_IMAGE(seq_lodge_image, seq_lodge , image)
		values(SEQ_LODGE_IMAGE.nextval , seq_lodge.currval, #{imagefilename})
	</insert>
	
 	<!--
 	
 	
 	
 	숙소 수정
 	<update id="updateLodge" parameterType="java.util.HashMap">
 		update tbl_lodge
 		set name = #{name}, type_lodge = #{type_lodge}, type_building = #{type_building},
 		location = #{location}, lat = #{lat}, lon = #{lon}, img_main = #{seq_lodge} || #{img_main}, num_of_people = #{num_of_people},
 		ROOM_PRICE = #{room_price}, deposit_price = #{deposit_price}, clean_price = #{clean_price}, total_price = #{total_price}
 		where seq_lodge = #{seq_lodge}
 	</update>
 	
 	<update id="updateLodgeIntro" parameterType="java.util.HashMap">
 		update tbl_lodge_intro
 		set rooms_explain = #{rooms_explain}, rooms_rule = #{rooms_rule}, refund_policy = #{refund_policy},
 		safety_function = #{safety_function}, local_information = #{local_information}
		where seq_lodge = #{seq_lodge}
 	</update>
 	
 	<update id="updateLodgeDetail" parameterType="java.util.HashMap">
 		update tbl_lodge_detail
		set num_of_bathroom = #{num_of_bathroom}, num_of_bedroom = #{num_of_bedroom}, num_of_bed = #{num_of_bed},
		checkin_time = #{checkin_time}, checkout_time = #{checkout_time}
		where seq_lodge = #{seq_lodge}
 	</update>
 	
 	<update id="updateLodgeDetail2" parameterType="java.util.HashMap">
 		update tbl_lodge_detail2
 		set elevator = #{elevator}, wifi = #{wifi}, air_controller = #{air_controller}, heating = #{heating},
 		washing_machine = #{washing_machine}, hair_dryer = #{hair_dryer}, tv = #{tv}, essential_item = #{essential_item}
		where seq_lodge = #{seq_lodge}
 	</update>
 	 -->
 	<!-- 
 	
 	
 	
 	
 	 -->
 	 
 	<!-- 위시리스트에 해당 숙소가 이미 있는지 확인 -->
 	<select id="selectCheckWishList" parameterType="java.util.HashMap" resultType="int">
		select count(*) as count
		from tbl_lodge_wish
		where 1 = 1
		
		<if test='seq_lodge != null and !"".equals(seq_lodge)'>
        	and seq_lodge = #{seq_lodge}
        </if>
		
		<if test='email != null and !"".equals(email)'>
        	and email = #{email}
        </if>
 	</select>
 	
 	
 	
 	<!-- 위시리스트에 해당 숙소를 삽입 -->
 	<insert id="insertWishList" parameterType="java.util.HashMap">
 		insert into tbl_lodge_wish(seq_lodge_wish, seq_lodge, email, status)
		values (seq_lodge_wish.nextval, #{seq_lodge}, #{email}, default)
 	</insert>
 	
 	
 	<!-- 위시리스트에 숙소가 있으면 (status == 1) 없음으로 (status == 0) 반대도 동일 -->
 	<update id="updateWishList" parameterType="java.util.HashMap">
 		update tbl_lodge_wish
 		
 		<if test="status == 0">
 			set status = 1
 		</if>
 		
 		<if test="status == 1">
 			set status = 0
 		</if>
 		
 		where 1 = 1
		
		<if test='seq_lodge != null and !"".equals(seq_lodge)'>
        	and seq_lodge = #{seq_lodge}
        </if>
		
		<if test='email != null and !"".equals(email)'>
        	and email = #{email}
        </if>
 	</update>


 	
 	<!-- 위시리스트에 있는 해당 숙소의 상태 불러오기 -->
 	<select id="selectWishListStatus" parameterType="java.util.HashMap" resultType="int">
		select status
		from tbl_lodge_wish
		where 1 = 1
		
		<if test='seq_lodge != null and !"".equals(seq_lodge)'>
        	and seq_lodge = #{seq_lodge}
        </if>
		
		<if test='email != null and !"".equals(email)'>
        	and email = #{email}
        </if>
 	</select>
 	
 	
 	<!-- 보여주는 목록 내에서 위시리스트 목록 불러오기 -->
 	<resultMap type="java.util.HashMap" id="roomsWishListMap">
	 		<result property="SEQ_LODGE" 		column="seq_lodge" 		javaType="int" />
	 		<result property="STATUS" 			column="status" 		javaType="int" />
	</resultMap>

	<select id="selectRoomsWishListInList" parameterType="java.util.HashMap" resultMap="roomsWishListMap">
 		select A.seq_lodge, nvl(B.status, 0) as status
        from tbl_lodge A left join tbl_lodge_wish B on A.seq_lodge = B.seq_lodge
        where A.status = 1

        <!-- 검색어 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and location like '%' || #{search_content} || '%'
        	or name like '%' || #{search_content} || '%'
        </if>
        
        <!-- 인원수 -->
        <if test='search_content != null and !"".equals(search_content)'>
        	and num_of_people <![CDATA[>=]]> #{str_numOfPeople}
        </if>
        
        <!-- 회원 -->
        <if test='email != null and !"".equals(email)'>
        	and email = #{email}
        </if>
        
        order by A.seq_lodge desc
 	</select>
 	
 	
 	
 	<!-- HY version -->
 	<!-- 숙소 모든정보를 받는 VO의 개념 -->
	<resultMap type="java.util.HashMap" id="totalroomdetail_resultmap">
    	<result property="roomno" 		column="seq_lodge" 		javaType="int" />
	    <result property="email" 	column="email" 		javaType="String" />
	    <result property="roomname" 	column="name" 	javaType="String" />
	    <result property="lodgetype" 	column="type_lodge" 	javaType="int" />
	    <result property="LAT" 	column="lat" 	javaType="String" />
	    <result property="LNG" 	column="lon" 	javaType="String" />
	    <result property="buildingtype" 	column="type_building" 		javaType="int" />
	    <result property="mainimage" column="img_main" 	javaType="String" />
	    <result property="maxpeople" column="num_of_people" 	javaType="int" />
	    <result property="roomprice" column="room_price" 	javaType="int" />
	    <result property="depositprice" column="deposit_price" 	javaType="int" />
	    <result property="cleanprice" column="clean_price" 	javaType="int" />
	    <result property="totalprice" column="total_price" 	javaType="int" />
	    <result property="roomstatus" column="status" 	javaType="int" />
	    <result property="bathroomcnt" column="NUM_OF_BATHROOM" 	javaType="int" />
	    <result property="bedroomcnt" column="NUM_OF_BEDROOM" 	javaType="int" />
	    <result property="bedcnt" column="NUM_OF_BED" 	javaType="int" />
	    <result property="Hcheckin" column="CHECKIN_TIME" 	javaType="String" />
	    <result property="Hcheckout" column="CHECKOUT_TIME" 	javaType="String" />
	    <result property="elevator" column="ELEVATOR" 	javaType="String" />
	    <result property="wifi" column="WIFI" 	javaType="String" />
	    <result property="aircontroller" column="AIR_CONTROLLER" 	javaType="String" />
	    <result property="heating" column="HEATING" 	javaType="String" />
	    <result property="washingmachine" column="WASHING_MACHINE" 	javaType="String" />
	    <result property="hairdryer" column="HAIR_DRYER" 	javaType="String" />
	    <result property="tv" column="TV" 	javaType="String" />
	    <result property="essentialitem" column="ESSENTIAL_ITEM" 	javaType="String" />
	    <result property="roomsexplain" column="ROOMS_EXPLAIN" 	javaType="String" />
	    <result property="roomsrule" column="ROOMS_RULE" 	javaType="String" />
	    <result property="refundpolicy" column="REFUND_POLICY" 	javaType="String" />
	    <result property="safetyfunction" column="SAFETY_FUNCTION" 	javaType="String" />
	    <result property="localinfomation" column="LOCAL_INFORMATION" 	javaType="String" />
	    <result property="hostname" column="HOSTNAME" 	javaType="String" />
	    
    </resultMap>


	<select id="getlistdetail" parameterType="java.util.HashMap" resultMap="totalroomdetail_resultmap">
	
	select seq_lodge , email , name , type_lodge, type_building, location
       ,lat, lon, img_main , num_of_people , room_price , deposit_price , clean_price , 
       total_price , status , NUM_OF_BATHROOM , NUM_OF_BEDROOM , NUM_OF_BED ,
       CHECKIN_TIME ,CHECKOUT_TIME ,
       case when ELEVATOR = 1 then 'on' else 'null' end as ELEVATOR,
       case when WIFI = 1 then 'on' else 'null' end as WIFI,
       case when AIR_CONTROLLER = 1 then 'on' else 'null' end as AIR_CONTROLLER,
       case when HEATING = 1 then 'on' else 'null' end as HEATING,
       case when WASHING_MACHINE = 1 then 'on' else 'null' end as WASHING_MACHINE,
       case when HAIR_DRYER = 1 then 'on' else 'null' end as HAIR_DRYER,
       case when TV = 1 then 'on' else 'null' end as TV,
       case when ESSENTIAL_ITEM = 1 then 'on' else 'null' end as ESSENTIAL_ITEM,
       case when HAIR_DRYER = 1 then 'on' else 'null' end as HAIR_DRYER,
       ROOMS_EXPLAIN, ROOMS_RULE , REFUND_POLICY , SAFETY_FUNCTION , LOCAL_INFORMATION
       ,HOSTNAME
    from view_tbl_lodge_totaldetail
	where seq_lodge = #{seq_lodge}
	
	</select>
</mapper>